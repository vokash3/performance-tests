# E R R O R S

# `10 DEC 2025`

Выявлено при нескольких итерациях запуска **_api_client_operations_full.py_**

## Kafka Topics

| Topic Name                        | Partitions | Out of sync replicas | Replication Factor | Number of messages | Size  |
|-----------------------------------|------------|----------------------|--------------------|--------------------|-------|
| IN __consumer_offsets             | 50         | 0                    | 1                  | 101497             | 15 MB |
| documents-service.contracts.inbox | 1          | 0                    | 1                  | 116                | 19 KB |
| documents-service.receipts.inbox  | 1          | 0                    | 1                  | 138                | 23 KB |
| documents-service.tariffs.inbox   | 1          | 0                    | 1                  | 116                | 20 KB |

---

## Ошибки и неполадки

### 1. Ошибки инициализации PostgreSQL

| Сервис        | Время                  | Ошибка                                                             |
|---------------|------------------------|--------------------------------------------------------------------|
| postgres-init | Многократно (12 DEC)   | `database "xxx_service_db" already exists`                         |
| postgres-init | Многократно (12 DEC)   | `role "xxx_service_user" already exists`                           |
| postgres      | 2025-12-08 21:45:14... | Те же ошибки: БД и роли уже существуют при повторной инициализации |

**Причина:**  
Скрипты инициализации PostgreSQL (`init-*.sql`) выполняются при каждом запуске контейнера. Если БД или пользователи уже
созданы, PostgreSQL выдаёт ошибки, но продолжает работу.

**Решение:**  
Использовать `CREATE DATABASE IF NOT EXISTS` и `CREATE USER IF NOT EXISTS` в SQL-скриптах.

---

### 2. Ошибки создания Kafka-топиков

| Сервис          | Время               | Ошибка                                                                        |
|-----------------|---------------------|-------------------------------------------------------------------------------|
| kafka-documents | 2025-12-08 16:48:24 | `Failed to create topic '...': _TIMED_OUT` — таймаут при ожидании контроллера |
| kafka-documents | 2025-12-08 21:45:13 | `TOPIC_ALREADY_EXISTS` — топик уже существует                                 |
| kafka-documents | 2025-12-10 18:53:52 | Повторный таймаут при создании топика                                         |

**Причина:**  
Сервис пытается создать топики при старте. При первом запуске может быть таймаут (Kafka не готов), при последующих —
топики уже существуют.

**Решение:**

- Проверять существование топика перед созданием.
- Реализовать повторные попытки (retry) при таймаутах.
- Использовать `AdminClient` с политикой `ignore_if_exists`.

---

### 3. Ошибки получения чеков (500 Internal Server Error)

| Сервис         | Время                  | Ошибка                                                                        |
|----------------|------------------------|-------------------------------------------------------------------------------|
| http-documents | Множество раз (12 DEC) | `Failed to download file receipt_xxx.pdf: NoSuchKey` — файл не найден в S3    |
| http-gateway   | Множество раз (12 DEC) | `GET ... - Unexpected status 500, retrying` — ошибка сервера при запросе чека |

**Цепочка ошибок:**

1. `http-documents` получает запрос на выдачу чека.
2. Пытается скачать PDF из S3.
3. Файл отсутствует (`NoSuchKey`) → выбрасывает исключение.
4. Возвращается `500 Internal Server Error`.
5. `http-gateway` получает `500`, логирует ошибку и пытается повторить (retry).

**Причина:**

- Чеки генерируются асинхронно (через Kafka), но запрашиваются слишком рано.
- Или файл не был загружен в S3 из-за сбоя в сервисе документов.
- Возможна рассинхронизация между БД (где чек "есть") и S3 (где его "нет").

**Решение:**

1. **Добавить проверку существования файла в S3** до попытки скачивания.
2. **Возвращать `404 Not Found`**, если чек не найден, а не `500`.
3. **Реализовать retry с backoff** на стороне `http-documents` при ошибках S3.
4. **Проверить логику генерации чеков** — убедиться, что файл загружается в S3 после создания.

---

### 4. Проблема с 500 ошибками: почему скрипты "падают и работают"

Скрипты (клиенты) **не падают полностью**, а:

- Получают `500` при запросе чека.
- Повторяют запрос (retry).
- Иногда повтор успешен (возможно, чек появился позже).
- → Поведение: "то работает, то нет".

**Рекомендации:**

- Улучшить обработку ошибок в `http-documents`.
- Централизовать логику retry.
- Добавить health-check для S3 и Kafka.
- Рассмотреть использование **кэширования** или **очереди запросов** на получение чеков.

---